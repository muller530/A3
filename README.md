# A3 客服知识库工具

基于 Tauri v2 + React + TypeScript 开发的桌面端客服知识库工具。

## 技术栈

- **桌面框架**: Tauri v2
- **前端框架**: React 18 + TypeScript
- **构建工具**: Vite
- **UI 组件库**: shadcn/ui + Tailwind CSS
- **包管理器**: npm / pnpm（两种方式都支持）
- **数据源**: 飞书多维表格 (Bitable)

## 前置要求

- **Node.js**: 18+ 
- **npm**: 10+ (已内置) 或 **pnpm**: 8+ (可选，可使用 `npx pnpm` 无需安装)
- **Rust**: 1.70+ (Tauri CLI 会自动安装，或手动安装：`curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh`)

## 快速开始

### 1. 安装依赖

**使用 npm（推荐）：**
```bash
npm install
```

**或使用 pnpm（使用 npx，无需全局安装）：**
```bash
npx pnpm install
```

### 2. 开发运行

**使用 npm：**
```bash
npm run dev
```

**或使用 pnpm：**
```bash
npx pnpm dev
```

首次运行会自动：
- 启动 Vite 开发服务器（`http://localhost:1420`）
- 编译 Tauri 后端（可能需要几分钟）
- 打开桌面应用窗口

### 3. 构建应用

**使用 npm：**
```bash
npm run tauri build
```

**或使用 pnpm：**
```bash
npx pnpm tauri build
```

构建产物位于 `src-tauri/target/release/` 目录。

## 项目结构

```
A3/
├── src/                    # React 前端
│   ├── components/        # 组件
│   │   ├── ui/           # shadcn/ui 组件
│   │   ├── Login.tsx     # 登录页
│   │   ├── Config.tsx    # 配置页
│   │   └── AnswerList.tsx # 答案列表页
│   ├── contexts/         # Context 状态管理
│   ├── lib/              # 工具函数和 API
│   ├── App.tsx           # 主应用组件
│   └── main.tsx          # 入口文件
├── src-tauri/            # Tauri 后端 (Rust)
│   ├── src/
│   │   ├── main.rs       # Tauri 入口
│   │   └── commands.rs   # 飞书 API 命令
│   ├── Cargo.toml        # Rust 依赖
│   └── tauri.conf.json    # Tauri 配置
├── public/               # 静态资源
├── package.json          # 前端依赖
└── vite.config.ts       # Vite 配置
```

## 功能特性

### 核心功能

- ✅ **用户角色管理**：支持普通用户（user）和管理员（admin）两种角色
- ✅ **飞书配置**：
  - 完整模式：配置 App ID、App Secret、App Token 和 Table ID，支持数据同步
  - 本地模式：仅配置 App Token 和 Table ID，只能查看缓存数据
- ✅ **AI 配置**：支持配置 AI API（API Key、Base URL、Model ID）
- ✅ **数据同步**：
  - 管理员：无限制同步
  - 普通用户：一天只能同步一次
  - 自动过滤只有问题没有答复的记录
- ✅ **智能搜索**：
  - 基于语义理解的匹配度计算
  - 支持同义词识别（如"区别"和"差异"、"不同"）
  - 显示匹配度百分比（颜色编码：绿色≥70%，黄色≥50%，红色<50%）
  - 按匹配度自动排序
- ✅ **新增问题**：所有用户都可以新增问题到飞书（标准回答字段留空）
- ✅ **答案管理**：
  - 答案列表展示（默认仅显示"启用"状态）
  - 答案详情查看（包含问题、标准回答、状态、场景、语气、产品等信息）
  - 产品信息关联展示
- ✅ **AI 功能**（管理员）：
  - AI 优化答案
  - AI 审核答案
  - AI 风险检测
  - 写回飞书（更新现有记录）
- ✅ **权限控制**：
  - 普通用户：可以配置、同步、搜索、查看、新增问题
  - 管理员：拥有所有权限，包括 AI 功能和写回飞书

## 使用说明

### 1. 首次使用

#### 1.1 登录
- 启动应用后，选择用户角色进行登录：
  - **普通用户（user）**：可以配置、同步（一天一次）、搜索、查看、新增问题
  - **管理员（admin）**：拥有所有权限，包括 AI 功能和写回飞书

#### 1.2 配置飞书
进入"设置中心" → "飞书设置"：

**完整模式（推荐）**：
- 填写 `FEISHU_APP_ID`（可选，用于同步功能）
- 填写 `FEISHU_APP_SECRET`（可选，用于同步功能）
- 配置 `BITABLE_APP_TOKEN`（必填，应用级别，所有表格共享）
- 配置表格：
  - `ANSWERS` 表格（必填）：答案数据表
  - `PRODUCTS` 表格（可选）：产品信息表

**本地模式**：
- 仅配置 `BITABLE_APP_TOKEN` 和 `Table ID`
- 只能查看缓存数据，无法同步最新数据

#### 1.3 配置 AI（可选）
进入"设置中心" → "AI 设置"：
- 填写 `API Key`
- 填写 `Base URL`
- 选择 `Model ID`
- 点击"测试连接"验证配置

### 2. 日常使用

#### 2.1 同步数据
- 点击右上角的"同步数据"按钮
- **管理员**：可以随时同步
- **普通用户**：一天只能同步一次，按钮会显示"今日已同步"并禁用

#### 2.2 搜索答案
- 在搜索框输入问题关键词
- 系统会：
  - 基于语义理解计算匹配度
  - 自动识别同义词（如"区别"和"差异"）
  - 按匹配度排序显示结果
  - 显示每个答案的匹配度百分比

#### 2.3 查看答案详情
- 点击答案卡片上的"查看详情"按钮
- 查看完整信息：
  - 问题内容
  - 标准回答
  - 状态、场景、语气
  - 关联产品信息（如果配置了产品表格）

#### 2.4 新增问题
当搜索结果中没有匹配度高于 70% 的答案时：
- 系统会显示提示："未找到匹配度高于70%的答案"
- 点击"新增这个问题到飞书"按钮
- 填写问题内容
- 点击"创建问题"提交
- 新问题会添加到飞书表格，标准回答字段留空，等待后续填写

#### 2.5 AI 功能（仅管理员）
在答案详情页面：
- **AI 优化**：优化答案内容，使其更专业、更易理解
- **AI 审核**：审核答案的专业性和准确性
- **风险检测**：检测答案中可能存在的风险点
- **写回飞书**：将优化或审核后的答案写回飞书表格

### 3. 功能说明

#### 3.1 匹配度计算
系统使用基于语义理解的匹配算法：
- **关键词提取**：自动提取有意义的关键词，过滤停用词
- **同义词识别**：识别同义词（如"区别"↔"差异"、"怎么"↔"如何"）
- **语义匹配**：基于关键词和语义进行匹配，而非简单的字符串相似度
- **匹配度显示**：
  - 绿色（≥70%）：高度匹配
  - 黄色（≥50%）：中等匹配
  - 红色（<50%）：低匹配

#### 3.2 同步限制
- **管理员**：无限制，可以随时同步
- **普通用户**：
  - 一天只能同步一次
  - 如果今天已同步过，按钮会显示"今日已同步"并禁用
  - 可以使用缓存数据，但无法获取最新数据

#### 3.3 权限说明
- **普通用户**：
  - ✅ 配置飞书和 AI
  - ✅ 同步数据（一天一次）
  - ✅ 搜索和查看答案
  - ✅ 新增问题到飞书
  - ❌ 写回飞书（更新现有记录）
  - ❌ AI 功能
  
- **管理员**：
  - ✅ 所有普通用户权限
  - ✅ 无限制同步
  - ✅ AI 优化、审核、风险检测
  - ✅ 写回飞书（更新现有记录）

### 4. 注意事项

#### 4.1 数据同步
- 同步时会自动过滤只有问题没有答复的记录
- 只有同时有问题和答复的记录才会同步到本地
- 本地模式无法同步，只能查看缓存数据

#### 4.2 匹配度提示
- 当搜索结果中最高匹配度低于 70% 时，系统会提示新增问题
- 建议在新增问题前，先检查是否可以通过调整搜索关键词找到答案

#### 4.3 飞书配置
- App ID 和 App Secret 用于数据同步功能
- 如果无法配置 App ID 和 App Secret，可以使用本地模式（仅查看缓存）
- App Token 和 Table ID 是必填项

## 开发命令

**使用 npm：**
```bash
# 开发模式（前端 + Tauri）
npm run dev

# 构建前端
npm run build

# 预览构建结果
npm run preview

# Tauri 相关命令
npm run tauri dev      # 开发模式
npm run tauri build    # 构建应用
npm run tauri info     # 显示环境信息
```

**使用 pnpm（通过 npx）：**
```bash
# 开发模式（前端 + Tauri）
npx pnpm dev

# 构建前端
npx pnpm build

# Tauri 相关命令
npx pnpm tauri dev      # 开发模式
npx pnpm tauri build    # 构建应用
```

## 常见问题

### 1. 首次运行很慢？

首次运行需要下载 Rust 工具链和编译依赖，可能需要 5-10 分钟，这是正常的。后续运行会快很多。

### 2. 端口 1420 被占用？

修改 `vite.config.ts` 中的 `server.port` 配置，或关闭占用该端口的程序。

### 3. Rust 编译错误？

确保 Rust 工具链是最新的：
```bash
rustup update
```

### 4. pnpm 命令不存在？

项目已配置为使用 npm，无需安装 pnpm。如果仍想使用 pnpm：

**方式 1（推荐）：** 使用 npx，无需安装
```bash
npx pnpm install
npx pnpm dev
```

**方式 2：** 全局安装（需要权限）
```bash
# macOS
brew install pnpm

# 或使用 npm（需要 sudo）
sudo npm install -g pnpm
```

详见 `INSTALL_PNPM.md` 文件。

### 5. Tauri 窗口无法打开？

- 检查终端是否有错误信息
- 确保 Vite 开发服务器正常运行（访问 `http://localhost:1420`）
- 查看 `src-tauri/target/debug/` 目录下的日志

### 6. 飞书 API 调用失败？

- 检查 App ID 和 App Secret 是否正确
- 确认应用有访问 Bitable 的权限
- 检查网络连接

### 7. 普通用户无法同步数据？

- 普通用户一天只能同步一次
- 如果今天已经同步过，按钮会显示"今日已同步"并禁用
- 可以使用缓存数据，或联系管理员同步

### 8. 匹配度计算不准确？

- 系统使用基于语义理解的匹配算法
- 支持同义词识别（如"区别"和"差异"）
- 匹配度基于关键词和语义，而非简单的字符串相似度
- 如果匹配度低于 70%，建议新增问题

### 9. 本地模式和完整模式的区别？

- **完整模式**：配置了 App ID 和 App Secret，可以同步最新数据
- **本地模式**：仅配置了 App Token 和 Table ID，只能查看缓存数据
- 本地模式适用于无法获取完整飞书凭证的情况

### 10. 如何新增问题？

- 当搜索结果中没有匹配度高于 70% 的答案时，系统会显示提示
- 点击"新增这个问题到飞书"按钮
- 填写问题内容并提交
- 新问题会添加到飞书表格，标准回答字段留空

### 11. 为什么有些记录没有同步？

- 系统会自动过滤只有问题没有答复的记录
- 只有同时有问题和答复的记录才会同步到本地
- 这是为了确保数据的完整性

## 环境变量

可以在 `.env` 文件中配置环境变量（如果需要）：

```env
VITE_API_BASE_URL=https://api.example.com
```

## 构建配置

### 开发环境

- 前端：Vite 开发服务器（HMR 热更新）
- 后端：Rust 调试模式
- 窗口：可调整大小，显示 DevTools

### 生产环境

- 前端：Vite 构建优化
- 后端：Rust 发布模式（优化）
- 窗口：根据 `tauri.conf.json` 配置

## 贡献指南

1. Fork 项目
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

## License

MIT

## 相关链接

- [Tauri 文档](https://tauri.app/)
- [React 文档](https://react.dev/)
- [shadcn/ui 文档](https://ui.shadcn.com/)
- [Tailwind CSS 文档](https://tailwindcss.com/)
